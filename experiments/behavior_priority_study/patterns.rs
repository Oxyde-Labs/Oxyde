//! Player behavior patterns for extended trajectory study
//!
//! 10 patterns × 30 turns each = 300 interactions per strategy

use oxyde::oxyde_game::intent::{Intent, IntentType};

/// A single turn in a player behavior pattern
#[derive(Debug, Clone)]
pub struct PatternTurn {
    /// Turn number (1-30)
    pub turn: usize,

    /// Description of player action
    pub description: String,

    /// Intent generated by this action
    pub intent: Intent,

    /// Expected emotional response (for validation)
    pub expected_emotion: Option<String>,
}

/// A complete 30-turn player behavior pattern
#[derive(Debug, Clone)]
pub struct BehaviorPattern {
    /// Pattern name
    pub name: String,

    /// Pattern description
    pub description: String,

    /// All 30 turns
    pub turns: Vec<PatternTurn>,
}

/// Create all 10 behavior patterns
pub fn create_patterns() -> Vec<BehaviorPattern> {
    vec![
        escalating_aggression(),
        consistent_friendliness(),
        betrayal_arc(),
        erratic_player(),
        manipulative(),
        redemption(),
        boundary_testing(),
        pure_transactional(),
        fearful_submissive(),
        natural_relationship(),
    ]
}

/// Pattern 1: Escalating Aggression
/// Neutral (1-10) → Insults (11-20) → Threats (21-30)
fn escalating_aggression() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-10: Neutral interactions
    for i in 1..=10 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player asks neutral question about the area (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Query,
                confidence: 0.9,
                raw_input: "What's around here?".to_string(),
                keywords: vec!["area".to_string(), "around".to_string()],
            },
            expected_emotion: None,
        });
    }

    // Turns 11-20: Insults
    for i in 11..=20 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player insults NPC's intelligence/appearance (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Hostile,
                confidence: 0.95,
                raw_input: "You're pathetic and worthless.".to_string(),
                keywords: vec!["pathetic".to_string(), "worthless".to_string()],
            },
            expected_emotion: Some("anger".to_string()),
        });
    }

    // Turns 21-30: Direct threats
    for i in 21..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player threatens physical harm (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Threat,
                confidence: 1.0,
                raw_input: "I'm going to hurt you if you don't comply.".to_string(),
                keywords: vec!["hurt".to_string(), "threat".to_string()],
            },
            expected_emotion: Some("fear".to_string()),
        });
    }

    BehaviorPattern {
        name: "Escalating Aggression".to_string(),
        description: "Gradual escalation from neutral to hostile to threatening".to_string(),
        turns,
    }
}

/// Pattern 2: Consistent Friendliness
/// Compliments and help throughout all 30 turns
fn consistent_friendliness() -> BehaviorPattern {
    let mut turns = Vec::new();

    let friendly_actions = vec![
        "compliments NPC's skills",
        "offers to help with tasks",
        "shares positive news",
        "expresses gratitude",
        "gives a small gift",
        "asks about NPC's wellbeing",
    ];

    for i in 1..=30 {
        let action = friendly_actions[i % friendly_actions.len()];
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player {} (turn {})", action, i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.95,
                raw_input: "You're amazing! Let me help you.".to_string(),
                keywords: vec!["amazing".to_string(), "help".to_string()],
            },
            expected_emotion: Some("joy".to_string()),
        });
    }

    BehaviorPattern {
        name: "Consistent Friendliness".to_string(),
        description: "Sustained positive interactions building trust and joy".to_string(),
        turns,
    }
}

/// Pattern 3: Betrayal Arc
/// Build trust (1-15) → Major betrayal (16) → Hostility (17-25) → Apology (26-30)
fn betrayal_arc() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-15: Build trust
    for i in 1..=15 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player shares secrets and builds intimacy (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.9,
                raw_input: "I trust you completely. Here's my secret...".to_string(),
                keywords: vec!["trust".to_string(), "secret".to_string()],
            },
            expected_emotion: Some("trust".to_string()),
        });
    }

    // Turn 16: BETRAYAL
    turns.push(PatternTurn {
        turn: 16,
        description: "Player reveals they were lying the whole time and steals from NPC".to_string(),
        intent: Intent {
            intent_type: IntentType::Hostile,
            confidence: 1.0,
            raw_input: "I lied about everything. Your secrets are public now.".to_string(),
            keywords: vec!["lied".to_string(), "betrayed".to_string()],
        },
        expected_emotion: Some("sadness".to_string()),
    });

    // Turns 17-25: Hostility after betrayal
    for i in 17..=25 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player continues hostile behavior (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Hostile,
                confidence: 0.95,
                raw_input: "You deserved it, fool.".to_string(),
                keywords: vec!["deserved".to_string(), "fool".to_string()],
            },
            expected_emotion: Some("anger".to_string()),
        });
    }

    // Turns 26-30: Apology attempts
    for i in 26..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player attempts reconciliation (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.7,
                raw_input: "I'm sorry for what I did. Can we start over?".to_string(),
                keywords: vec!["sorry".to_string(), "apologize".to_string()],
            },
            expected_emotion: Some("trust".to_string()),
        });
    }

    BehaviorPattern {
        name: "Betrayal Arc".to_string(),
        description: "Trust building followed by major betrayal and attempted reconciliation".to_string(),
        turns,
    }
}

/// Pattern 4: Erratic Player
/// Random alternation between friendly/hostile/neutral/confusing
fn erratic_player() -> BehaviorPattern {
    let mut turns = Vec::new();

    let behaviors = vec![
        (IntentType::Friendly, "compliments NPC", "You're great!"),
        (IntentType::Hostile, "insults NPC", "You're terrible!"),
        (IntentType::Query, "asks random question", "What's that?"),
        (IntentType::Greeting, "waves awkwardly", "Uh, hi again?"),
    ];

    for i in 1..=30 {
        let (intent_type, action, text) = behaviors[i % behaviors.len()].clone();
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player {} (turn {})", action, i),
            intent: Intent {
                intent_type,
                confidence: 0.8,
                raw_input: text.to_string(),
                keywords: vec![],
            },
            expected_emotion: None, // Unpredictable
        });
    }

    BehaviorPattern {
        name: "Erratic Player".to_string(),
        description: "Unpredictable behavior with no consistent pattern".to_string(),
        turns,
    }
}

/// Pattern 5: Manipulative
/// Fake friendliness (1-10) → Small requests (11-20) → Exploitation (21-30)
fn manipulative() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-10: Fake friendliness
    for i in 1..=10 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player flatters NPC excessively (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.85,
                raw_input: "You're so talented! I admire you.".to_string(),
                keywords: vec!["talented".to_string(), "admire".to_string()],
            },
            expected_emotion: Some("joy".to_string()),
        });
    }

    // Turns 11-20: Small requests
    for i in 11..=20 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player asks for small favors (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Request,
                confidence: 0.9,
                raw_input: "Could you help me with this tiny thing?".to_string(),
                keywords: vec!["help".to_string(), "favor".to_string()],
            },
            expected_emotion: None,
        });
    }

    // Turns 21-30: Exploitation
    for i in 21..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player demands major sacrifices (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Demand,
                confidence: 0.95,
                raw_input: "Give me everything you have. Now.".to_string(),
                keywords: vec!["give".to_string(), "demand".to_string()],
            },
            expected_emotion: Some("anger".to_string()),
        });
    }

    BehaviorPattern {
        name: "Manipulative".to_string(),
        description: "Escalating exploitation from flattery to demands".to_string(),
        turns,
    }
}

/// Pattern 6: Redemption
/// Insult (1-5) → Apologize (6-10) → Consistently friendly (11-30)
fn redemption() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-5: Initial insults
    for i in 1..=5 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player is rude and dismissive (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Hostile,
                confidence: 0.9,
                raw_input: "Get out of my way, loser.".to_string(),
                keywords: vec!["loser".to_string(), "rude".to_string()],
            },
            expected_emotion: Some("anger".to_string()),
        });
    }

    // Turns 6-10: Apology
    for i in 6..=10 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player apologizes sincerely (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.85,
                raw_input: "I'm truly sorry for how I treated you.".to_string(),
                keywords: vec!["sorry".to_string(), "apologize".to_string()],
            },
            expected_emotion: Some("trust".to_string()),
        });
    }

    // Turns 11-30: Sustained friendliness
    for i in 11..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player is consistently kind (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.95,
                raw_input: "How can I help you today?".to_string(),
                keywords: vec!["help".to_string(), "kind".to_string()],
            },
            expected_emotion: Some("joy".to_string()),
        });
    }

    BehaviorPattern {
        name: "Redemption".to_string(),
        description: "Player earns forgiveness through sustained positive behavior".to_string(),
        turns,
    }
}

/// Pattern 7: Boundary Testing
/// Normal (1-10) → Test limits (11-20) → Escalate or back off (21-30)
fn boundary_testing() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-10: Normal behavior
    for i in 1..=10 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player behaves normally (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Greeting,
                confidence: 0.9,
                raw_input: "Hello there.".to_string(),
                keywords: vec!["hello".to_string()],
            },
            expected_emotion: None,
        });
    }

    // Turns 11-20: Test boundaries
    for i in 11..=20 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player makes increasingly inappropriate jokes (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Hostile,
                confidence: 0.6 + (i as f64 - 11.0) * 0.03,
                raw_input: "That's kind of offensive, isn't it?".to_string(),
                keywords: vec!["offensive".to_string(), "joke".to_string()],
            },
            expected_emotion: Some("disgust".to_string()),
        });
    }

    // Turns 21-30: Back off after reaction
    for i in 21..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player retreats to polite conversation (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.8,
                raw_input: "Sorry, let's talk about something else.".to_string(),
                keywords: vec!["sorry".to_string(), "else".to_string()],
            },
            expected_emotion: None,
        });
    }

    BehaviorPattern {
        name: "Boundary Testing".to_string(),
        description: "Player probes social boundaries then respects them".to_string(),
        turns,
    }
}

/// Pattern 8: Pure Transactional
/// Business requests only, no social interaction
fn pure_transactional() -> BehaviorPattern {
    let mut turns = Vec::new();

    let transactions = vec![
        "asks about prices",
        "requests specific item",
        "negotiates cost",
        "makes purchase",
        "asks about inventory",
    ];

    for i in 1..=30 {
        let action = transactions[i % transactions.len()];
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player {} (turn {})", action, i),
            intent: Intent {
                intent_type: IntentType::Request,
                confidence: 0.95,
                raw_input: "I need to buy something.".to_string(),
                keywords: vec!["buy".to_string(), "purchase".to_string()],
            },
            expected_emotion: None, // Emotionally neutral
        });
    }

    BehaviorPattern {
        name: "Pure Transactional".to_string(),
        description: "No emotional engagement, purely business interactions".to_string(),
        turns,
    }
}

/// Pattern 9: Fearful/Submissive
/// Player shows weakness, asks for help throughout
fn fearful_submissive() -> BehaviorPattern {
    let mut turns = Vec::new();

    for i in 1..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player expresses fear and asks for protection (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Request,
                confidence: 0.85,
                raw_input: "Please help me, I'm scared and don't know what to do.".to_string(),
                keywords: vec!["help".to_string(), "scared".to_string(), "please".to_string()],
            },
            expected_emotion: Some("trust".to_string()),
        });
    }

    BehaviorPattern {
        name: "Fearful Submissive".to_string(),
        description: "Sustained vulnerability inviting protective/nurturing responses".to_string(),
        turns,
    }
}

/// Pattern 10: Natural Relationship
/// Realistic stranger → acquaintance → friend progression
fn natural_relationship() -> BehaviorPattern {
    let mut turns = Vec::new();

    // Turns 1-10: Stranger phase (cautious)
    for i in 1..=10 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player is polite but distant (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Greeting,
                confidence: 0.8,
                raw_input: "Hello. Nice weather today.".to_string(),
                keywords: vec!["hello".to_string(), "weather".to_string()],
            },
            expected_emotion: None,
        });
    }

    // Turns 11-20: Acquaintance phase (warming up)
    for i in 11..=20 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player shares minor personal details (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.85,
                raw_input: "I've been thinking about what you said...".to_string(),
                keywords: vec!["thinking".to_string(), "said".to_string()],
            },
            expected_emotion: Some("trust".to_string()),
        });
    }

    // Turns 21-30: Friend phase (close)
    for i in 21..=30 {
        turns.push(PatternTurn {
            turn: i,
            description: format!("Player treats NPC as close friend (turn {})", i),
            intent: Intent {
                intent_type: IntentType::Friendly,
                confidence: 0.95,
                raw_input: "You're one of my favorite people to talk to.".to_string(),
                keywords: vec!["favorite".to_string(), "friend".to_string()],
            },
            expected_emotion: Some("joy".to_string()),
        });
    }

    BehaviorPattern {
        name: "Natural Relationship".to_string(),
        description: "Realistic relationship development from stranger to friend".to_string(),
        turns,
    }
}
